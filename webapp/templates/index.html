<script>
      $(document).ready(function() {
        $('#videoSelect').on('change', function() {
          var videoPath = $(this).val();
          var unique = Date.now();
          // Always show the video element, do not remove/re-add
          $('#videoFeedImg').show();
          $('#videoFeedImg').attr('src', '/video_feed?video=' + videoPath + '&_=' + unique);
          // Detection will be triggered by backend model inference, not by AJAX here
        });
      });

      function showDetectionPopup(eventType, confidence, timestamp) {
        // ...existing code...
      }
      $('#videoFeedImg').on('error', function() {
        console.error('MJPEG stream failed to load:', $(this).attr('src'));
        $(this).attr('alt', 'Video stream failed to load');
      });
    </script>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Live Feed & Stats</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    {% extends 'base.html' %} {% block content %}
    <div class="row mb-4">
      <div class="container-fluid px-2 py-2">
        <div class="row gx-2 gy-2">
          <div class="col-12 col-lg-7 mb-2">
            <h2 class="mb-2">Live Video Feed</h2>
            <div class="card shadow-sm mb-2">
              <div class="card-body p-2 text-center">
                <div class="mb-2">
                  <label for="sourceToggle" class="mr-2">Source:</label>
                  <select id="sourceToggle" class="form-control d-inline-block w-auto">
                    <option value="camera" selected>Camera</option>
                    <option value="video">Video File</option>
                  </select>
                  <span id="cameraSelectWrapper">
                    <label for="cameraSelect" class="ml-2">Camera:</label>
                    <select id="cameraSelect" class="form-control d-inline-block w-auto">
                      <option value="builtin" selected>Built-in Webcam</option>
                      <option value="usb">USB Camera</option>
                      <option value="ip">IP Camera</option>
                    </select>
                  </span>
                  <span id="videoSelectWrapper" style="display:none;">
                    <label for="videoSelect" class="ml-2">Video:</label>
                    <select id="videoSelect" class="form-control d-inline-block w-auto">
                      {% for video in video_list %}
                        <!-- <option value="{{ video['path'] }}">Video {{ video['name'] }} ({{ video['class'] }})</option> -->
                           <option value="{{ video['path'] }}">Video {{ video['name'] }}</option> 
                      {% endfor %}
                    </select>
                  </span>
                </div>
                <img
                  id="videoFeedImg"
                  src="{{ url_for('video_feed', source='builtin') }}"
                  class="img-fluid rounded"
                  style="max-width: 100%; height: auto;"
                />
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-5 mb-2">
            <div class="row gx-2 gy-2">
              <div class="col-12 col-md-4 mb-2">
                <div class="card text-white bg-primary h-100">
                  <div class="card-body p-2">
                    <h6 class="card-title mb-1">Total Detections</h6>
                    <p class="card-text display-6 mb-0">{{ total_detections }}</p>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4 mb-2">
                <div class="card text-white bg-success h-100">
                  <div class="card-body p-2">
                    <h6 class="card-title mb-1">Most Frequent Anomaly</h6>
                    <p class="card-text display-6 mb-0">{{ most_anomaly }}</p>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4 mb-2">
                <div class="card text-white bg-dark h-100">
                  <div class="card-body p-2">
                    <h6 class="card-title mb-1">Last Detection</h6>
                    <p class="card-text mb-0">{{ last_detection }}</p>
                  </div>
                </div>
              </div>
            </div>
            <h5 class="mt-3 mb-2">Recent Detections</h5>
            <div class="table-responsive">
              <table class="table table-bordered table-striped align-middle mb-2">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Type</th>
                    
                    <th>Timestamp</th>
                    <th>Screenshot</th>
                     <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for detection in detections %}
                  <tr id="detection-row-{{ detection['id'] }}">
                    <td>{{ detection['id'] }}</td>
                    <td>
                      <span
                        class="badge bg-{{
                          'danger' if detection['event_type'] != 'normal'
                          else 'secondary'
                        }}"
                        >{{ detection['event_type'] }}</span
                      >
                    </td>
                   
                    <td>{{ detection['timestamp'] }}</td>
                    <td>
                      {% if detection['screenshot_path'] %}
                      <a
                        href="{{ url_for('static', filename=detection['screenshot_path']) }}"
                        target="_blank"
                      >
                        <img
                          src="{{ url_for('static', filename=detection['screenshot_path']) }}"
                          alt="Screenshot"
                          style="
                            width: 48px;
                            height: 32px;
                            border-radius: 4px;
                            border: 1px solid #ccc;
                          "
                        />
                      </a>
                      {% else %}-{% endif %}
                    </td>
                    <td>
                      <button class="btn btn-sm btn-danger delete-detection-btn" data-id="{{ detection['id'] }}">Delete</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <h5 class="mt-3 mb-2">Anomaly Frequency</h5>
            <div class="card p-2 mb-2">
              <canvas id="anomalyChart" width="100%" height="120"></canvas>
              <div class="mt-2">
                {% if anomaly_data.counts|length == 0 or (anomaly_data.counts|length == 1 and anomaly_data.counts[0] == 0) %}
                  <div class="text-danger">No anomaly data available for chart.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      $(document).ready(function() {
        $('#sourceToggle').on('change', function() {
          if ($(this).val() === 'camera') {
            $('#cameraSelectWrapper').show();
            $('#videoSelectWrapper').hide();
            $('#videoFeedImg').show();
            var camSource = $('#cameraSelect').val();
            $('#videoFeedImg').attr('src', '/video_feed?source=' + camSource);
          } else if ($(this).val() === 'video') {
            $('#cameraSelectWrapper').hide();
            $('#videoSelectWrapper').show();
            $('#videoFeedImg').show();
            var vidSource = $('#videoSelect').val();
            // Always use MJPEG stream for video playback
            if (vidSource.startsWith('/video_data/')) {
              vidSource = vidSource.replace('/video_data/', '');
            }
            $('#videoFeedImg').attr('src', '/video_feed?video=' + vidSource);
          }
        });
        $('#cameraSelect').on('change', function() {
          var camSource = $(this).val();
          $('#videoFeedImg').attr('src', '/video_feed?source=' + camSource);
        });
        $('#videoSelect').on('change', function() {
          var videoPath = $(this).val();
          var unique = Date.now();
          // Always show the video element, do not remove/re-add
          $('#videoFeedImg').show();
          $('#videoFeedImg').attr('src', '/video_feed?video=' + videoPath + '&_=' + unique);
          // Simulate detection immediately when video selected
          $.ajax({
            url: '/simulate_detection',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ video_path: videoPath }),
            success: function(resp) {
              console.log('Detection simulated on video select:', resp);
              if (resp.status === 'success' && resp.event_type !== 'normal') {
                setTimeout(function() {
                  showDetectionPopup(resp.event_type, resp.confidence, resp.timestamp);
                }, 30000);
              }
            },
            error: function(xhr, status, error) {
              console.error('Failed to simulate detection on video select:', error);
            }
          });
        });
      });
    </script>
        <script>
          $(document).on('click', '.delete-detection-btn', function() {
            var detectionId = $(this).data('id');
            if (confirm('Are you sure you want to delete this detection?')) {
              $.ajax({
                url: '/delete_detection/' + detectionId,
                type: 'POST',
                success: function(response) {
                  $('#detection-row-' + detectionId).remove();
                },
                error: function() {
                  alert('Failed to delete detection.');
                }
              });
            }
          });
        </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var anomalyData = JSON.parse('{{ anomaly_data | tojson | safe }}');
        var ctx = document.getElementById("anomalyChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: anomalyData.labels,
            datasets: [
              {
                label: "Detections",
                data: anomalyData.counts,
                backgroundColor: "rgba(220,53,69,0.7)",
                borderColor: "rgba(220,53,69,1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      });
    </script>
    {% endblock %}
  </body>
</html>
