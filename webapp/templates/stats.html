<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Detection Stats</title>
    <style>
      table {
        border-collapse: collapse;
        width: 80%;
        margin: 20px auto;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #eee;
      }
    </style>
  </head>
  <body>
    {% extends 'base.html' %} {% block content %}
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-white bg-primary mb-2">
            <div class="card-body">
              <h5 class="card-title">Total Detections</h5>
              <p class="card-text display-6">{{ total_detections }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success mb-2">
            <div class="card-body">
              <h5 class="card-title">Most Frequent Anomaly</h5>
              <p class="card-text display-6">{{ most_anomaly }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-dark mb-2">
            <div class="card-body">
              <h5 class="card-title">Last Detection</h5>
              <p class="card-text">{{ last_detection }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info mb-2">
            <div class="card-body">
              <h5 class="card-title">Detection Rate (24h)</h5>
              <p class="card-text display-6">{{ detection_rate }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-md-8">
          <h4 class="mb-3">Detection History</h4>
          <div class="card p-3 mb-3">
            <canvas id="lineChart" width="100%" height="80"></canvas>
            <div class="mt-2">
              {% if line_chart_data.counts|length == 0 or
              (line_chart_data.counts|length == 1 and line_chart_data.counts[0]
              == 0) %}
              <div class="text-danger">
                No detection history data available for chart.
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <h4 class="mb-3">Anomaly Frequency</h4>
          <div class="card p-3 mb-3">
            <canvas id="barChart" width="100%" height="180"></canvas>
            <div class="mt-2">
              {% if anomaly_data.counts|length == 0 or
              (anomaly_data.counts|length == 1 and anomaly_data.counts[0] == 0)
              %}
              <div class="text-danger">
                No anomaly data available for chart.
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <h4 class="mb-3">All Detections</h4>
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Type</th>

                  <th>Timestamp</th>
                  <th>Screenshot</th>
                </tr>
              </thead>
              <tbody>
                {% for detection in detections %}
                <tr>
                  <td>{{ detection['id'] }}</td>
                  <td>
                    <span
                      class="badge bg-{{ 'danger' if detection['event_type'] != 'normal' else 'secondary' }}"
                      >{{ detection['event_type'] }}</span
                    >
                  </td>

                  <td>{{ detection['timestamp'] }}</td>
                  <td>
                    {% if detection['screenshot_path'] %}
                    <a
                      href="{{ url_for('static', filename=detection['screenshot_path']) }}"
                      target="_blank"
                    >
                      <img
                        href="{{ url_for('static', filename=detection['screenshot_path']) }}"
                        alt="Screenshot"
                        style="
                          width: 48px;
                          height: 32px;
                          border-radius: 4px;
                          border: 1px solid #ccc;
                        "
                      />
                    </a>
                    {% else %}-{% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var lineData = JSON.parse('{{ line_chart_data | tojson | safe }}');

          var lineData = {{ line_chart_data | tojson | safe }};

        var lineCtx = document.getElementById("lineChart").getContext("2d");
        new Chart(lineCtx, {
          type: "line",
          data: {
            labels: lineData.labels,
            datasets: [
              {
                label: "Detections per Hour",
                data: lineData.counts,
                backgroundColor: "rgba(13,202,240,0.2)",
                borderColor: "rgba(13,202,240,1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
        var anomalyData = JSON.parse('{{ anomaly_data | tojson | safe }}');

          var anomalyData = {{ anomaly_data | tojson | safe }};

        var barCtx = document.getElementById("barChart").getContext("2d");
        new Chart(barCtx, {
          type: "bar",
          data: {
            labels: anomalyData.labels,
            datasets: [
              {
                label: "Detections",
                data: anomalyData.counts,
                backgroundColor: "rgba(220,53,69,0.7)",
                borderColor: "rgba(220,53,69,1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      });
    </script>
    {% endblock %}
  </body>
</html>
